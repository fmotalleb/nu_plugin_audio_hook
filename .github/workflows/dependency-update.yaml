on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */2 * *'

name: Update dependencies

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Install ALSA packages
        run: |
          sudo apt-get update
          sudo apt-get install -y alsa-utils libasound2-dev

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: "0.108.0"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Save HEAD before commit
        id: head_before
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Upgrade dependencies
        id: upgrade
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: nu {0}
        run: |
          def "gh latest tag" [repo: string]: nothing -> string {
            http get --headers [Authorization $"Bearer ($env.GITHUB_TOKEN)"] $"https://api.github.com/repos/($repo)/releases/latest"
              | get tag_name
          }

          let plugin_repository = "nushell/nushell"
          let plugin_version = (try {
              http get https://crates.io/api/v1/crates/nu-plugin?include=keywords%2Ccategories%2Cdownloads%2Cdefault_version
                | get crate.default_version
            } catch {
              gh latest tag $plugin_repository
            })
          let sanitized_plugin_version = ($plugin_version | str replace --regex "^v" "")

          mut content = (open Cargo.toml --raw)

          # Update package version
          $content = ($content | str replace --regex '(?m)^version\s*=\s*".*?"' $"version = \"($sanitized_plugin_version)\"" --range 0..1)

          let toml_data = (open Cargo.toml)
          let nu_deps = ($toml_data.dependencies | columns | where ($it =~ "^nu-.*"))

          for dep in $nu_deps {
            $content = ($content | str replace --regex $"(?m)^($dep)\\s*=\\s*\".*?\"" $"${1}\"($sanitized_plugin_version)\"")
            $content = ($content | str replace --regex $"(?s)(\[dependencies\.($dep)\][^\[]*?version\\s*=\\s*)\".*?\"" $"${1}\"($sanitized_plugin_version)\"")
            $content = ($content | str replace --regex $"(?m)^($dep)\\s*=.*version\\s*=\\s*\"[^\"]+\"" $"${1}\"($sanitized_plugin_version)\"")
          }

          let inter_val = ($toml_data.dependencies | get -i interprocess)
          if ($inter_val | describe | str starts-with "record") {
              $content = ($content | str replace --regex '(?s)(\[dependencies\.interprocess\][^\[]*?version\s*=\s*)".*?"' '${1}"=2.2.1"')
              $content = ($content | str replace --regex '(?m)^(interprocess\s*=.*version\s*=\s*)".*?"' '${1}"=2.2.1"')
          } else {
              $content = ($content | str replace --regex '(?m)^interprocess\s*=\s*".*?"' 'interprocess = "=2.2.1"')
          }

          $content | save --force Cargo.toml

          open nupm.nuon --raw
            | str replace --regex '(\s*version:\s*)".*?"' $"${1}\"($sanitized_plugin_version)\""
            | save --force nupm.nuon

          cargo update interprocess --precise 2.2.1
          cargo update
          cargo check

      - name: Update CONTRIBUTORS.md
        run: |
          echo "# Contributors" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          git shortlog -sn --all \
            | grep -v "GitHub-Action" \
            | awk '{
                count=$1; $1="";
                sub(/^ /, "");
                plural = (count == 1) ? "commit" : "commits";
                print "- **"count" "plural"** â€” "$0
              }' >> CONTRIBUTORS.md

      - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5  # v9
        with:
          author_name: GitHub-Action
          message: "chore: bump dependencies and update contributors"

      - name: Check for new commits
        id: check_commits
        run: |
          if [ "$(git rev-parse --short HEAD)" != "${{ steps.head_before.outputs.sha }}" ]; then
            echo "has_commits=1" >> $GITHUB_OUTPUT
          else
            echo "has_commits=0" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version
        id: extract_version
        if: steps.check_commits.outputs.has_commits == '1'
        shell: nu {0}
        run: |
          let version = (open Cargo.toml | get package.version | str trim)
          $"version=($version)" | save --force $env.GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check_commits.outputs.has_commits == '1'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          name: Release v${{ steps.extract_version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
