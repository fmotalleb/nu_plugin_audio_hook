on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */2 * *'

name: Update dependencies

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Install ALSA packages
        run: |
          sudo apt-get update
          sudo apt-get install -y alsa-utils libasound2-dev

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: "0.108.0"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Save HEAD before commit
        id: head_before
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Upgrade dependencies
        id: upgrade
        shell: nu {0}
        run: |
          # Pinned to commit 2b1f15507005879c0c4d026390bc8d09d97270f8 (2025-06-25: use crates.io for version lookup)
          http get https://raw.githubusercontent.com/FMotalleb/nushell_sync_script/2b1f15507005879c0c4d026390bc8d09d97270f8/bump_dependencies.nu
            | save /tmp/update.nu
          nu /tmp/update.nu

      - name: Update CONTRIBUTORS.md
        run: |
          echo "# Contributors" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          git shortlog -sn --all \
            | grep -v "GitHub-Action" \
            | awk '{
                count=$1; $1="";
                sub(/^ /, "");
                plural = (count == 1) ? "commit" : "commits";
                print "- **"count" "plural"** â€” "$0
              }' >> CONTRIBUTORS.md

      - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5  # v9
        with:
          author_name: GitHub-Action
          message: "chore: bump dependencies and update contributors"

      - name: Check for new commits
        id: check_commits
        run: |
          if [ "$(git rev-parse --short HEAD)" != "${{ steps.head_before.outputs.sha }}" ]; then
            echo "has_commits=1" >> $GITHUB_OUTPUT
          else
            echo "has_commits=0" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version
        id: extract_version
        if: steps.check_commits.outputs.has_commits == '1'
        shell: nu {0}
        run: |
          let version = (open Cargo.toml | get package.version | str trim)
          $"version=($version)" | save --force $env.GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check_commits.outputs.has_commits == '1'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          name: Release v${{ steps.extract_version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
