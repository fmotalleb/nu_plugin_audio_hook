on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */2 * *'

name: Update dependencies

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Install ALSA packages
        run: |
          sudo apt-get update
          sudo apt-get install -y alsa-utils libasound2-dev

      - name: Setup Nushell
        uses: hustcer/setup-nu@v3
        with:
          version: "0.108.0"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Save HEAD before commit
        id: head_before
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Upgrade dependencies
        id: upgrade
        shell: nu {0}
        run: |
          def "gh latest tag" [repo: string]: nothing -> string {
            http get $"https://api.github.com/repos/($repo)/releases/latest"
              | get tag_name
          }

          let plugin_repository = "nushell/nushell"
          let plugin_version = (try {
              http get https://crates.io/api/v1/crates/nu-plugin?include=keywords%2Ccategories%2Cdownloads%2Cdefault_version
                | get versions
                | first
                | get num
            } catch {
              gh latest tag $plugin_repository
            })

          let toml = (open Cargo.toml)
          mut deps = ($toml | get dependencies)
          let fields = ($toml | get dependencies | columns | where ($it =~ "nu-.*"))

          for i in $fields {
            $deps = ($deps | update $i ($deps | get $i | update version $plugin_version))
          }

          $deps = ($deps | update interprocess "=2.2.1")

          $toml
            | update package ($toml | get package | update version $plugin_version)
            | update dependencies $deps
            | save Cargo.toml --force

          open nupm.nuon
            | update version $plugin_version
            | save nupm.nuon --force

          cargo update interprocess --precise 2.2.1
          cargo update
          cargo build

      - name: Update CONTRIBUTORS.md
        run: |
          echo "# Contributors" > CONTRIBUTORS.md
          echo "" >> CONTRIBUTORS.md
          git shortlog -sn --all \
            | grep -v "GitHub-Action" \
            | awk '{
                count=$1; $1="";
                sub(/^ /, "");
                plural = (count == 1) ? "commit" : "commits";
                print "- **"count" "plural"** â€” "$0
              }' >> CONTRIBUTORS.md

      - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5  # v9
        with:
          author_name: GitHub-Action
          message: "chore: bump dependencies and update contributors"

      - name: Check for new commits
        id: check_commits
        run: |
          if [ "$(git rev-parse --short HEAD)" != "${{ steps.head_before.outputs.sha }}" ]; then
            echo "has_commits=1" >> $GITHUB_OUTPUT
          else
            echo "has_commits=0" >> $GITHUB_OUTPUT
          fi

      - name: Extract Version
        id: extract_version
        if: steps.check_commits.outputs.has_commits == '1'
        shell: nu {0}
        run: |
          let version = (open Cargo.toml | get package.version | str trim)
          $"version=($version)" | save --force $env.GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check_commits.outputs.has_commits == '1'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: v${{ steps.extract_version.outputs.version }}
          name: Release v${{ steps.extract_version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
